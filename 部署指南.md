# 服务器部署指南

## 快速部署

### 方式一：手动登录服务器部署（推荐）

1. **SSH 登录服务器**
```bash
ssh root@47.108.150.198
# 输入密码
```

2. **上传并执行部署脚本**

在本地执行（将脚本上传到服务器）：
```bash
scp deploy-server.sh root@47.108.150.198:/root/
```

在服务器上执行：
```bash
cd /root
chmod +x deploy-server.sh
./deploy-server.sh
```

---

### 方式二：逐步手动部署

SSH 登录服务器后，执行以下命令：

```bash
# 1. 进入项目目录
cd /root/wechat_demo

# 2. 拉取最新代码
git pull origin main

# 3. 停止旧服务
ps aux | grep wechat-work-callback | grep -v grep | awk '{print $2}' | xargs kill -9

# 4. 检查 Redis
if ! pgrep -x "redis-server" > /dev/null; then
    redis-server --daemonize yes
fi

# 5. 编译项目
mvn clean package -DskipTests

# 6. 启动服务
nohup java -jar target/wechat-work-callback-1.0.0.jar > /root/wechat-app.log 2>&1 &

# 7. 查看日志
tail -f /root/wechat-app.log
```

---

## 验证部署

### 1. 检查服务状态
```bash
# 查看进程
ps aux | grep wechat-work-callback

# 查看端口
netstat -tlnp | grep 8080

# 测试健康检查
curl http://localhost:8080/api/wechat/health
```

### 2. 查看日志
```bash
# 实时查看日志
tail -f /root/wechat-app.log

# 查看最近 100 行
tail -n 100 /root/wechat-app.log

# 搜索错误
grep ERROR /root/wechat-app.log
```

### 3. 外网访问测试
```bash
# 从外网测试（在本地执行）
curl http://47.108.150.198:8080/api/wechat/health
```

---

## 常见问题

### 1. 端口被占用
```bash
# 查找占用 8080 端口的进程
lsof -i :8080

# 杀死进程
kill -9 <PID>
```

### 2. Redis 未启动
```bash
# 启动 Redis
redis-server --daemonize yes

# 检查 Redis 状态
redis-cli ping
# 应该返回 PONG
```

### 3. Java 未安装或版本错误
```bash
# 检查 Java 版本
java -version

# 安装 Java 8（CentOS）
yum install -y java-1.8.0-openjdk java-1.8.0-openjdk-devel

# 安装 Java 8（Ubuntu）
apt-get update
apt-get install -y openjdk-8-jdk
```

### 4. Maven 未安装
```bash
# 安装 Maven（CentOS）
yum install -y maven

# 安装 Maven（Ubuntu）
apt-get install -y maven
```

### 5. Git 拉取失败
```bash
# 检查 git 状态
cd /root/wechat_demo
git status

# 放弃本地修改
git reset --hard HEAD
git pull origin main
```

---

## 配置检查

### 确认配置文件
```bash
cat /root/wechat_demo/src/main/resources/application.yml
```

确保以下配置正确：
- ✅ `corp-id`: wwd79126fde9eba684
- ✅ `app-secret`: A_EExWJkm0mioE_h8esb_Q10tsF3S1DB4Rqtbwm9ATs
- ✅ `token`: JKBYwA8yEwhjKEyKWRQe
- ✅ `encoding-aes-key`: 3b3NP2JJACgzakSh3Enh1vGsWsWVcAbsXjlVeFEKLRi
- ✅ `h5-base-url`: http://47.108.150.198:8080/h5/oauth.html

---

## 企业微信配置

部署成功后，需要在企业微信管理后台配置：

### 1. 配置回调 URL
```
URL: http://47.108.150.198:8080/api/wechat/callback
Token: JKBYwA8yEwhjKEyKWRQe
EncodingAESKey: 3b3NP2JJACgzakSh3Enh1vGsWsWVcAbsXjlVeFEKLRi
```

### 2. 测试流程
1. 添加一个测试客户
2. 查看服务器日志，应该能看到：
   - 收到回调消息
   - 解密成功
   - 获取到 external_id
   - 发送欢迎语成功

---

## 停止服务

```bash
# 查找进程
ps aux | grep wechat-work-callback | grep -v grep

# 停止服务
ps aux | grep wechat-work-callback | grep -v grep | awk '{print $2}' | xargs kill -9
```

---

## 重启服务

```bash
# 快速重启（使用脚本）
/root/deploy-server.sh

# 手动重启
cd /root/wechat_demo
ps aux | grep wechat-work-callback | grep -v grep | awk '{print $2}' | xargs kill -9
nohup java -jar target/wechat-work-callback-1.0.0.jar > /root/wechat-app.log 2>&1 &
```

