## 🚀 本地测试快速步骤（适合有真实企业微信环境）

### 第一步：启动本地服务（5分钟）

#### 1. 确保Redis运行
```bash
# 检查Redis
redis-cli ping  # 应该返回PONG

# 如果没运行，启动Redis
redis-server
# 或
brew services start redis
```

#### 2. 配置企业微信信息

编辑 `src/main/resources/application.yml`，填入你的真实信息：

```yaml
wechat:
  work:
    corp-id: ww你的企业ID              # ← 在企业微信后台"我的企业"获取
    contact-secret: 你的客户联系Secret  # ← 在"应用管理-客户联系"获取
    token: MyTestToken123              # ← 先随便写，后面会修改
    encoding-aes-key: 随便43个字符     # ← 先随便写，后面会自动生成
    h5-base-url: http://临时地址        # ← 后面会更新
```

#### 3. 启动Spring Boot

**用IDEA（最简单）：**
1. 用IDEA打开项目
2. 找到 `WechatWorkCallbackApplication.java`
3. 右键 → Run
4. 看到"企业微信回调服务启动成功！"

**或用命令行：**
```bash
cd /Users/taogonglin/projects/wechat_demo

# 运行快速启动脚本
./quick-start-local.sh

# 或直接运行
mvn spring-boot:run
```

#### 4. 验证服务运行

打开浏览器访问：http://localhost:8080/api/wechat/health

应该看到：`OK`

---

### 第二步：设置内网穿透（5分钟）

#### 1. 安装并启动ngrok

**安装（macOS）：**
```bash
brew install ngrok
```

**启动（新开一个终端窗口）：**
```bash
ngrok http 8080
```

你会看到类似输出：
```
Forwarding   https://abc123def456.ngrok.io -> http://localhost:8080
```

**复制这个URL：** `https://abc123def456.ngrok.io`

#### 2. 更新配置

编辑 `src/main/resources/application.yml`：

```yaml
wechat:
  work:
    h5-base-url: https://abc123def456.ngrok.io/h5/oauth.html  # ← 用你的ngrok URL
```

**重启Spring Boot应用！**

#### 3. 验证公网访问

在浏览器访问：`https://abc123def456.ngrok.io/api/wechat/health`

应该看到：`OK`

---

### 第三步：配置企业微信回调（10分钟）

#### 1. 登录企业微信管理后台

访问：https://work.weixin.qq.com/

#### 2. 配置接收事件服务器

1. 进入「应用管理」→「客户联系」
2. 找到「接收事件服务器」
3. 点击「设置接收事件服务器」

填写：
```
URL: https://abc123def456.ngrok.io/api/wechat/callback
Token: MyTestToken123  （先用这个）
EncodingAESKey: （点击"随机生成"）
```

4. **重要：复制生成的EncodingAESKey**
5. **暂时不要点保存！**

#### 3. 更新配置文件

把刚才复制的Token和EncodingAESKey更新到 `application.yml`：

```yaml
wechat:
  work:
    token: MyTestToken123
    encoding-aes-key: 粘贴刚才复制的43位key
```

**重启Spring Boot应用！**

#### 4. 验证回调URL

返回企业微信后台，点击「保存」

如果显示「保存成功」，恭喜！✅

**如果失败：**
- 检查ngrok是否在运行
- 检查Token和Key是否一致
- 查看Spring Boot日志

#### 5. 配置事件订阅

在同一页面的「企业客户事件」中勾选：
- ✅ 添加企业客户事件

点击「保存」

#### 6. 配置可信域名（用于OAuth）

1. 在「客户联系」应用页面
2. 找到「网页授权及JS-SDK」
3. 配置「可信域名」
4. 输入：`abc123def456.ngrok.io` （不要加https://）
5. 保存

---

### 第四步：测试新客户添加（5分钟）

#### 1. 生成联系二维码

1. 企业微信后台 →「客户联系」→「联系我」
2. 点击「添加」，创建新的「联系我」
3. 生成二维码

#### 2. 测试流程

```
1. 用个人微信扫码
2. 添加企业微信客服
3. 在企业微信中查看是否收到欢迎消息
4. 消息中应该包含H5链接
5. 点击链接，测试表单填写
```

#### 3. 查看日志

在Spring Boot控制台应该看到：
```
收到回调消息
解密后的消息内容: <xml>...</xml>
检测到客户添加事件
收到客户添加事件 - External UserID: wmxxxxxx
发送欢迎语成功
```

✅ 如果看到这些日志，第一个功能测试成功！

---

### 第五步：测试存量客户批量发送（10分钟）

#### 1. 获取员工UserID

1. 企业微信后台 →「通讯录」
2. 找到你的客服人员
3. 查看「账号」，这就是UserID
4. 复制，例如：`ZhangSan`

#### 2. 查看客户列表

打开终端，运行：
```bash
curl "http://localhost:8080/api/customer/list?staffUserId=ZhangSan"
```

应该返回客户列表：
```json
{
  "success": true,
  "count": 3,
  "customers": ["wmxxx1", "wmxxx2", "wmxxx3"]
}
```

#### 3. 批量发送测试

```bash
curl -X POST "http://localhost:8080/api/customer/batch-send?staffUserId=ZhangSan"
```

应该返回：
```json
{
  "success": true,
  "msgid": "msgGCAAAXtWy...",
  "message": "群发任务创建成功"
}
```

#### 4. 在企业微信查看

1. 打开企业微信（电脑版或手机版）
2. 应该收到多条发送任务通知
3. 点击「确认发送」
4. 客户会收到群发消息

#### 5. 客户端测试

用你的个人微信（作为客户）：
1. 在企业微信聊天中查看收到的消息
2. 点击H5链接
3. 应该看到"身份验证中"
4. 自动跳转到OAuth授权页面
5. 点击「确认」
6. 返回H5页面，自动显示你的信息
7. 填写表单测试

✅ 如果能自动识别身份，OAuth功能测试成功！

#### 6. 查询群发结果

```bash
# 使用刚才返回的msgid
curl "http://localhost:8080/api/customer/batch-send-result?msgid=msgGCAAAXtWy..."
```

---

### 常见问题速查

#### ❌ 问题1：启动失败，端口被占用
```bash
# 查看占用8080的进程
lsof -i :8080
# 杀死进程
kill -9 <PID>
```

#### ❌ 问题2：Redis连接失败
```bash
# 启动Redis
redis-server
# 或
brew services start redis
```

#### ❌ 问题3：URL验证失败
- ✅ 确认ngrok在运行：`ngrok http 8080`
- ✅ 确认Token和Key一致
- ✅ 查看Spring Boot日志
- ✅ 重启Spring Boot

#### ❌ 问题4：收不到回调事件
- ✅ URL验证是否成功
- ✅ 事件订阅是否勾选
- ✅ 客户是否真的添加成功

#### ❌ 问题5：OAuth授权失败
- ✅ 可信域名是否配置：`abc123def456.ngrok.io`
- ✅ 链接是否在企业微信中打开
- ✅ CorpId是否正确

---

### 📊 测试检查清单

#### 新客户功能
- [ ] Redis运行正常
- [ ] Spring Boot启动成功
- [ ] ngrok运行正常
- [ ] URL验证通过
- [ ] 事件订阅配置
- [ ] 添加客户收到欢迎消息
- [ ] 点击链接可访问H5
- [ ] 表单可以提交

#### 存量客户功能
- [ ] 可信域名配置
- [ ] 能获取客户列表
- [ ] 批量发送成功
- [ ] 客户收到群发消息
- [ ] 点击链接跳转OAuth
- [ ] OAuth授权成功
- [ ] 自动识别客户身份
- [ ] 表单显示正常

---

### 🎉 测试成功！

如果以上步骤都通过，恭喜你！系统已经可以正常工作了。

**下一步：**
1. 部署到生产环境（参考 [deployment-guide.md](deployment-guide.md)）
2. 添加数据库存储客户信息
3. 完善表单提交后的处理逻辑

---

### 📚 相关文档

- [LOCAL-TEST-GUIDE.md](LOCAL-TEST-GUIDE.md) - 详细的本地测试指南
- [OAUTH-GUIDE.md](OAUTH-GUIDE.md) - OAuth完整说明
- [BATCH-SEND-EXAMPLE.md](BATCH-SEND-EXAMPLE.md) - 批量发送示例

---

**需要帮助？** 查看Spring Boot日志或ngrok日志排查问题。

